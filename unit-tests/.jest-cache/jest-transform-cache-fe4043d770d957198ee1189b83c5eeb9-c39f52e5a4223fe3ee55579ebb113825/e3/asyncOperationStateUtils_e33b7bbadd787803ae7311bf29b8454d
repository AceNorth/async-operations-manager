533e59c71f7a2c9431240dbbd73c48a4
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _config = _interopRequireDefault(require("./config"));

var _constants = require("./constants");

var _helpers = require("./helpers");

var _types = require("./types");

var _asyncOperationUtils = require("./asyncOperationUtils");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};
    var ownKeys = Object.keys(source);

    if (typeof Object.getOwnPropertySymbols === 'function') {
      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {
        return Object.getOwnPropertyDescriptor(source, sym).enumerable;
      }));
    }

    ownKeys.forEach(function (key) {
      _defineProperty(target, key, source[key]);
    });
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var updateAsyncOperationDescriptor = function updateAsyncOperationDescriptor(asyncOperationDescriptors, descriptorOptions) {
  var asyncOperationDescriptor = _objectSpread({
    debug: false,
    parentOperationDescriptorId: null,
    alwaysImmutable: false,
    minCacheTime: 5000,
    maxCacheTime: 60000
  }, descriptorOptions);

  _propTypes.default.checkPropTypes(_types.asyncOperationDescriptorPropType, asyncOperationDescriptor, 'prop', 'asyncOperationDescriptor');

  return _objectSpread({}, asyncOperationDescriptors, _defineProperty({}, asyncOperationDescriptor.descriptorId, asyncOperationDescriptor));
}; // validate whether the asyncOperationDescriptor exists


var getAsyncOperationDescriptor = function getAsyncOperationDescriptor(asyncOperationDescriptors, descriptorId) {
  var config = _config.default.getConfig();

  var asyncOperationDescriptor = asyncOperationDescriptors[descriptorId];

  if (!asyncOperationDescriptor) {
    config.logger.warningsCallback("descriptorId \"".concat(descriptorId, "\" does not match with any registered async operation descriptor"));
    return null;
  }

  if (asyncOperationDescriptor.debug) {
    config.logger.verboseLoggingCallback("Inside getAsyncOperationDescriptor for ".concat(descriptorId));
    config.logger.infoLoggingCallback('getAsyncOperationDescriptor [Data Snapshot]:', {
      asyncOperationDescriptors: asyncOperationDescriptors,
      asyncOperationDescriptor: asyncOperationDescriptor
    });
  }

  return asyncOperationDescriptor;
}; // This function will do all the work to determine if an async operation is returned as an initial async operation
// (if it is not found in state), an asyncOperation with parentAsyncOperation metaData (recursively searched to find if the parentAsyncOperation is more
// up-to-date) or just the asyncOperation itself if the none of the above apply.


var getAsyncOperation = function getAsyncOperation(state, registeredAsyncOperationDescriptors, asyncOperationKey, asyncOperationDescriptor, asyncOperationParams, fieldsToAdd) {
  var config = _config.default.getConfig();

  var fieldsToAddToAction = _objectSpread({}, asyncOperationParams, fieldsToAdd, {
    // key for the descriptor of the asyncOperation
    descriptorId: asyncOperationDescriptor.descriptorId
  });

  var parentAsyncOperation;
  var asyncOperation = state[asyncOperationKey] || null;

  if (asyncOperationDescriptor.parentOperationDescriptorId) {
    // grab key, descriptor, params, and async operation for parentAsyncOperation
    var parentAsyncOperationDescriptor = getAsyncOperationDescriptor(registeredAsyncOperationDescriptors, asyncOperationDescriptor.parentOperationDescriptorId);
    var parentAsyncOperationParams = (0, _helpers.getAndValidateParams)(asyncOperationParams, parentAsyncOperationDescriptor);
    var parentAsyncOperationKey = (0, _helpers.generateAsyncOperationKey)(asyncOperationDescriptor.parentOperationDescriptorId, parentAsyncOperationParams);
    parentAsyncOperation = getAsyncOperation(state, registeredAsyncOperationDescriptors, parentAsyncOperationKey, parentAsyncOperationDescriptor, asyncOperationParams, fieldsToAddToAction);
  }

  if (asyncOperationDescriptor.debug) {
    config.logger.verboseLoggingCallback("Inside getAsyncOperation for ".concat(asyncOperationKey));
    config.logger.infoLoggingCallback('getAsyncOperation [Data Snapshot]:', {
      state: state,
      asyncOperationParams: asyncOperationParams,
      asyncOperationDescriptor: asyncOperationDescriptor,
      asyncOperation: asyncOperation,
      asyncOperationKey: asyncOperationKey
    });
  }

  if (!asyncOperation) {
    if (asyncOperationDescriptor.debug) {
      config.logger.verboseLoggingCallback("asyncOperation not found with given key: ".concat(asyncOperationKey, ". Defaulting to an initial asyncOperation"));
    }

    asyncOperation = asyncOperationDescriptor.operationType === _constants.ASYNC_OPERATION_TYPES.READ ? (0, _asyncOperationUtils.initialReadAsyncOperationForAction)(asyncOperationDescriptor.descriptorId, fieldsToAddToAction, parentAsyncOperation) : (0, _asyncOperationUtils.initialWriteAsyncOperationForAction)(asyncOperationDescriptor.descriptorId, fieldsToAddToAction, parentAsyncOperation);
  } // We want to determine whether or not to use that parentAsyncOperation metaData based on the
  // newness of it's data in comparison to the asyncOperation


  if (parentAsyncOperation && asyncOperation) {
    return parentAsyncOperation.lastDataStatusTime.valueOf() > asyncOperation.lastDataStatusTime.valueOf() ? _objectSpread({}, asyncOperation, (0, _lodash.pick)(parentAsyncOperation, _constants.readAsyncOperationFieldsToPullFromParent)) : asyncOperation;
  }

  return asyncOperation;
};

var updateAsyncOperation = function updateAsyncOperation(state, asyncOperationKey, asyncOperation, asyncOperationDescriptor) {
  var config = _config.default.getConfig();

  if (asyncOperationDescriptor.debug) {
    config.logger.verboseLoggingCallback("Inside updateAsyncOperation for ".concat(asyncOperationKey));
    config.logger.infoLoggingCallback('updateAsyncOperation [Data Snapshot]:', {
      state: state,
      asyncOperationDescriptor: asyncOperationDescriptor,
      asyncOperation: asyncOperation,
      asyncOperationKey: asyncOperationKey
    });
  }

  _propTypes.default.checkPropTypes(_types.asyncOperationPropType, asyncOperation, 'prop', 'asyncOperation');

  return _objectSpread({}, state, _defineProperty({}, asyncOperationKey, asyncOperation));
};

var bulkUpdateAsyncOperations = function bulkUpdateAsyncOperations(state, asyncOperationsList) {
  return (0, _lodash.reduce)(asyncOperationsList, function (accumulator, _ref) {
    var asyncOperationKey = _ref.asyncOperationKey,
        asyncOperation = _ref.asyncOperation,
        asyncOperationDescriptor = _ref.asyncOperationDescriptor;
    return updateAsyncOperation(accumulator, asyncOperationKey, asyncOperation, asyncOperationDescriptor);
  }, state);
};

var _default = {
  updateAsyncOperationDescriptor: updateAsyncOperationDescriptor,
  updateAsyncOperation: updateAsyncOperation,
  bulkUpdateAsyncOperations: bulkUpdateAsyncOperations,
  getAsyncOperation: getAsyncOperation,
  getAsyncOperationDescriptor: getAsyncOperationDescriptor
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzeW5jT3BlcmF0aW9uU3RhdGVVdGlscy5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImRlZmF1bHQiLCJfbG9kYXNoIiwicmVxdWlyZSIsIl9wcm9wVHlwZXMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2NvbmZpZyIsIl9jb25zdGFudHMiLCJfaGVscGVycyIsIl90eXBlcyIsIl9hc3luY09wZXJhdGlvblV0aWxzIiwib2JqIiwiX19lc01vZHVsZSIsIl9vYmplY3RTcHJlYWQiLCJ0YXJnZXQiLCJpIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwic291cmNlIiwib3duS2V5cyIsImtleXMiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJjb25jYXQiLCJmaWx0ZXIiLCJzeW0iLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwiZm9yRWFjaCIsImtleSIsIl9kZWZpbmVQcm9wZXJ0eSIsImNvbmZpZ3VyYWJsZSIsIndyaXRhYmxlIiwidXBkYXRlQXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yIiwiYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9ycyIsImRlc2NyaXB0b3JPcHRpb25zIiwiYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yIiwiZGVidWciLCJwYXJlbnRPcGVyYXRpb25EZXNjcmlwdG9ySWQiLCJhbHdheXNJbW11dGFibGUiLCJtaW5DYWNoZVRpbWUiLCJtYXhDYWNoZVRpbWUiLCJjaGVja1Byb3BUeXBlcyIsImFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvclByb3BUeXBlIiwiZGVzY3JpcHRvcklkIiwiZ2V0QXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yIiwiY29uZmlnIiwiZ2V0Q29uZmlnIiwibG9nZ2VyIiwid2FybmluZ3NDYWxsYmFjayIsInZlcmJvc2VMb2dnaW5nQ2FsbGJhY2siLCJpbmZvTG9nZ2luZ0NhbGxiYWNrIiwiZ2V0QXN5bmNPcGVyYXRpb24iLCJzdGF0ZSIsInJlZ2lzdGVyZWRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3JzIiwiYXN5bmNPcGVyYXRpb25LZXkiLCJhc3luY09wZXJhdGlvblBhcmFtcyIsImZpZWxkc1RvQWRkIiwiZmllbGRzVG9BZGRUb0FjdGlvbiIsInBhcmVudEFzeW5jT3BlcmF0aW9uIiwiYXN5bmNPcGVyYXRpb24iLCJwYXJlbnRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IiLCJwYXJlbnRBc3luY09wZXJhdGlvblBhcmFtcyIsImdldEFuZFZhbGlkYXRlUGFyYW1zIiwicGFyZW50QXN5bmNPcGVyYXRpb25LZXkiLCJnZW5lcmF0ZUFzeW5jT3BlcmF0aW9uS2V5Iiwib3BlcmF0aW9uVHlwZSIsIkFTWU5DX09QRVJBVElPTl9UWVBFUyIsIlJFQUQiLCJpbml0aWFsUmVhZEFzeW5jT3BlcmF0aW9uRm9yQWN0aW9uIiwiaW5pdGlhbFdyaXRlQXN5bmNPcGVyYXRpb25Gb3JBY3Rpb24iLCJsYXN0RGF0YVN0YXR1c1RpbWUiLCJ2YWx1ZU9mIiwicGljayIsInJlYWRBc3luY09wZXJhdGlvbkZpZWxkc1RvUHVsbEZyb21QYXJlbnQiLCJ1cGRhdGVBc3luY09wZXJhdGlvbiIsImFzeW5jT3BlcmF0aW9uUHJvcFR5cGUiLCJidWxrVXBkYXRlQXN5bmNPcGVyYXRpb25zIiwiYXN5bmNPcGVyYXRpb25zTGlzdCIsInJlZHVjZSIsImFjY3VtdWxhdG9yIiwiX3JlZiIsIl9kZWZhdWx0Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQixLQUFLLENBQXZCOztBQUVBLElBQUlDLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBckI7O0FBRUEsSUFBSUMsVUFBVSxHQUFHQyxzQkFBc0IsQ0FBQ0YsT0FBTyxDQUFDLFlBQUQsQ0FBUixDQUF2Qzs7QUFFQSxJQUFJ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RUFBNkI7QUFDM0UsUUFBSTFCLGlCQUFpQixHQUFHMEIsSUFBSSxDQUFDMUIsaUJBQTdCO0FBQUEsUUFDSUssY0FBYyxHQUFHcUIsSUFBSSxDQUFDckIsY0FEMUI7QUFBQSxRQUVJeEIsd0JBQXdCLEdBQUc2QyxJQUFJLENBQUM3Qyx3QkFGcEM7QUFHQSxXQUFPdUMsb0JBQW9CLENBQUNLLFdBQUQsRUFBY3pCLGlCQUFkLEVBQWlDSyxjQUFqQyxFQUFpRHhCLHdCQUFqRCxDQUEzQjtBQUNELEdBTE0sRUFLSmlCLEtBTEksQ0FBUDtBQU1ELENBUEQ7O0FBU0EsSUFBSTZCLFFBQVEsR0FBRztBQUNiakQsRUFBQUEsOEJBQThCLEVBQUVBLDhCQURuQjtBQUViMEMsRUFBQUEsb0JBQW9CLEVBQUVBLG9CQUZUO0FBR2JFLEVBQUFBLHlCQUF5QixFQUFFQSx5QkFIZDtBQUliekIsRUFBQUEsaUJBQWlCLEVBQUVBLGlCQUpOO0FBS2JQLEVBQUFBLDJCQUEyQixFQUFFQTtBQUxoQixDQUFmO0FBT0E3QyxPQUFPLENBQUNFLE9BQVIsR0FBa0JnRixRQUFsQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwO1xuXG52YXIgX2xvZGFzaCA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5cbnZhciBfcHJvcFR5cGVzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwicHJvcC10eXBlc1wiKSk7XG5cbnZhciBfY29uZmlnID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9jb25maWdcIikpO1xuXG52YXIgX2NvbnN0YW50cyA9IHJlcXVpcmUoXCIuL2NvbnN0YW50c1wiKTtcblxudmFyIF9oZWxwZXJzID0gcmVxdWlyZShcIi4vaGVscGVyc1wiKTtcblxudmFyIF90eXBlcyA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xuXG52YXIgX2FzeW5jT3BlcmF0aW9uVXRpbHMgPSByZXF1aXJlKFwiLi9hc3luY09wZXJhdGlvblV0aWxzXCIpO1xuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG5mdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTsgdmFyIG93bktleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOyBpZiAodHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICdmdW5jdGlvbicpIHsgb3duS2V5cyA9IG93bktleXMuY29uY2F0KE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoc291cmNlKS5maWx0ZXIoZnVuY3Rpb24gKHN5bSkgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIHN5bSkuZW51bWVyYWJsZTsgfSkpOyB9IG93bktleXMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KTsgfSByZXR1cm4gdGFyZ2V0OyB9XG5cbmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHsgaWYgKGtleSBpbiBvYmopIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7IHZhbHVlOiB2YWx1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KTsgfSBlbHNlIHsgb2JqW2tleV0gPSB2YWx1ZTsgfSByZXR1cm4gb2JqOyB9XG5cbnZhciB1cGRhdGVBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IgPSBmdW5jdGlvbiB1cGRhdGVBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IoYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9ycywgZGVzY3JpcHRvck9wdGlvbnMpIHtcbiAgdmFyIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvciA9IF9vYmplY3RTcHJlYWQoe1xuICAgIGRlYnVnOiBmYWxzZSxcbiAgICBwYXJlbnRPcGVyYXRpb25EZXNjcmlwdG9ySWQ6IG51bGwsXG4gICAgYWx3YXlzSW1tdXRhYmxlOiBmYWxzZSxcbiAgICBtaW5DYWNoZVRpbWU6IDUwMDAsXG4gICAgbWF4Q2FjaGVUaW1lOiA2MDAwMFxuICB9LCBkZXNjcmlwdG9yT3B0aW9ucyk7XG5cbiAgX3Byb3BUeXBlcy5kZWZhdWx0LmNoZWNrUHJvcFR5cGVzKF90eXBlcy5hc3luY09wZXJhdGlvbkRlc2NyaXB0b3JQcm9wVHlwZSwgYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yLCAncHJvcCcsICdhc3luY09wZXJhdGlvbkRlc2NyaXB0b3InKTtcblxuICByZXR1cm4gX29iamVjdFNwcmVhZCh7fSwgYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9ycywgX2RlZmluZVByb3BlcnR5KHt9LCBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IuZGVzY3JpcHRvcklkLCBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IpKTtcbn07IC8vIHZhbGlkYXRlIHdoZXRoZXIgdGhlIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvciBleGlzdHNcblxuXG52YXIgZ2V0QXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yID0gZnVuY3Rpb24gZ2V0QXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yKGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcnMsIGRlc2NyaXB0b3JJZCkge1xuICB2YXIgY29uZmlnID0gX2NvbmZpZy5kZWZhdWx0LmdldENvbmZpZygpO1xuXG4gIHZhciBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IgPSBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3JzW2Rlc2NyaXB0b3JJZF07XG5cbiAgaWYgKCFhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IpIHtcbiAgICBjb25maWcubG9nZ2VyLndhcm5pbmdzQ2FsbGJhY2soXCJkZXNjcmlwdG9ySWQgXFxcIlwiLmNvbmNhdChkZXNjcmlwdG9ySWQsIFwiXFxcIiBkb2VzIG5vdCBtYXRjaCB3aXRoIGFueSByZWdpc3RlcmVkIGFzeW5jIG9wZXJhdGlvbiBkZXNjcmlwdG9yXCIpKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGlmIChhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IuZGVidWcpIHtcbiAgICBjb25maWcubG9nZ2VyLnZlcmJvc2VMb2dnaW5nQ2FsbGJhY2soXCJJbnNpZGUgZ2V0QXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yIGZvciBcIi5jb25jYXQoZGVzY3JpcHRvcklkKSk7XG4gICAgY29uZmlnLmxvZ2dlci5pbmZvTG9nZ2luZ0NhbGxiYWNrKCdnZXRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IgW0RhdGEgU25hcHNob3RdOicsIHtcbiAgICAgIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcnM6IGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcnMsXG4gICAgICBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3I6IGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvclxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcjtcbn07IC8vIFRoaXMgZnVuY3Rpb24gd2lsbCBkbyBhbGwgdGhlIHdvcmsgdG8gZGV0ZXJtaW5lIGlmIGFuIGFzeW5jIG9wZXJhdGlvbiBpcyByZXR1cm5lZCBhcyBhbiBpbml0aWFsIGFzeW5jIG9wZXJhdGlvblxuLy8gKGlmIGl0IGlzIG5vdCBmb3VuZCBpbiBzdGF0ZSksIGFuIGFzeW5jT3BlcmF0aW9uIHdpdGggcGFyZW50QXN5bmNPcGVyYXRpb24gbWV0YURhdGEgKHJlY3Vyc2l2ZWx5IHNlYXJjaGVkIHRvIGZpbmQgaWYgdGhlIHBhcmVudEFzeW5jT3BlcmF0aW9uIGlzIG1vcmVcbi8vIHVwLXRvLWRhdGUpIG9yIGp1c3QgdGhlIGFzeW5jT3BlcmF0aW9uIGl0c2VsZiBpZiB0aGUgbm9uZSBvZiB0aGUgYWJvdmUgYXBwbHkuXG5cblxudmFyIGdldEFzeW5jT3BlcmF0aW9uID0gZnVuY3Rpb24gZ2V0QXN5bmNPcGVyYXRpb24oc3RhdGUsIHJlZ2lzdGVyZWRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3JzLCBhc3luY09wZXJhdGlvbktleSwgYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yLCBhc3luY09wZXJhdGlvblBhcmFtcywgZmllbGRzVG9BZGQpIHtcbiAgdmFyIGNvbmZpZyA9IF9jb25maWcuZGVmYXVsdC5nZXRDb25maWcoKTtcblxuICB2YXIgZmllbGRzVG9BZGRUb0FjdGlvbiA9IF9vYmplY3RTcHJlYWQoe30sIGFzeW5jT3BlcmF0aW9uUGFyYW1zLCBmaWVsZHNUb0FkZCwge1xuICAgIC8vIGtleSBmb3IgdGhlIGRlc2NyaXB0b3Igb2YgdGhlIGFzeW5jT3BlcmF0aW9uXG4gICAgZGVzY3JpcHRvcklkOiBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IuZGVzY3JpcHRvcklkXG4gIH0pO1xuXG4gIHZhciBwYXJlbnRBc3luY09wZXJhdGlvbjtcbiAgdmFyIGFzeW5jT3BlcmF0aW9uID0gc3RhdGVbYXN5bmNPcGVyYXRpb25LZXldIHx8IG51bGw7XG5cbiAgaWYgKGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvci5wYXJlbnRPcGVyYXRpb25EZXNjcmlwdG9ySWQpIHtcbiAgICAvLyBncmFiIGtleSwgZGVzY3JpcHRvciwgcGFyYW1zLCBhbmQgYXN5bmMgb3BlcmF0aW9uIGZvciBwYXJlbnRBc3luY09wZXJhdGlvblxuICAgIHZhciBwYXJlbnRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IgPSBnZXRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3IocmVnaXN0ZXJlZEFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcnMsIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvci5wYXJlbnRPcGVyYXRpb25EZXNjcmlwdG9ySWQpO1xuICAgIHZhciBwYXJlbnRBc3luY09wZXJhdGlvblBhcmFtcyA9ICgwLCBfaGVscGVycy5nZXRBbmRWYWxpZGF0ZVBhcmFtcykoYXN5bmNPcGVyYXRpb25QYXJhbXMsIHBhcmVudEFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcik7XG4gICAgdmFyIHBhcmVudEFzeW5jT3BlcmF0aW9uS2V5ID0gKDAsIF9oZWxwZXJzLmdlbmVyYXRlQXN5bmNPcGVyYXRpb25LZXkpKGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvci5wYXJlbnRPcGVyYXRpb25EZXNjcmlwdG9ySWQsIHBhcmVudEFzeW5jT3BlcmF0aW9uUGFyYW1zKTtcbiAgICBwYXJlbnRBc3luY09wZXJhdGlvbiA9IGdldEFzeW5jT3BlcmF0aW9uKHN0YXRlLCByZWdpc3RlcmVkQXN5bmNPcGVyYXRpb25EZXNjcmlwdG9ycywgcGFyZW50QXN5bmNPcGVyYXRpb25LZXksIHBhcmVudEFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvciwgYXN5bmNPcGVyYXRpb25QYXJhbXMsIGZpZWxkc1RvQWRkVG9BY3Rpb24pO1xuICB9XG5cbiAgaWYgKGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvci5kZWJ1Zykge1xuICAgIGNvbmZpZy5sb2dnZXIudmVyYm9zZUxvZ2dpbmdDYWxsYmFjayhcIkluc2lkZSBnZXRBc3luY09wZXJhdGlvbiBmb3IgXCIuY29uY2F0KGFzeW5jT3BlcmF0aW9uS2V5KSk7XG4gICAgY29uZmlnLmxvZ2dlci5pbmZvTG9nZ2luZ0NhbGxiYWNrKCdnZXRBc3luY09wZXJhdGlvbiBbRGF0YSBTbmFwc2hvdF06Jywge1xuICAgICAgc3RhdGU6IHN0YXRlLFxuICAgICAgYXN5bmNPcGVyYXRpb25QYXJhbXM6IGFzeW5jT3BlcmF0aW9uUGFyYW1zLFxuICAgICAgYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yOiBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IsXG4gICAgICBhc3luY09wZXJhdGlvbjogYXN5bmNPcGVyYXRpb24sXG4gICAgICBhc3luY09wZXJhdGlvbktleTogYXN5bmNPcGVyYXRpb25LZXlcbiAgICB9KTtcbiAgfVxuXG4gIGlmICghYXN5bmNPcGVyYXRpb24pIHtcbiAgICBpZiAoYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yLmRlYnVnKSB7XG4gICAgICBjb25maWcubG9nZ2VyLnZlcmJvc2VMb2dnaW5nQ2FsbGJhY2soXCJhc3luY09wZXJhdGlvbiBub3QgZm91bmQgd2l0aCBnaXZlbiBrZXk6IFwiLmNvbmNhdChhc3luY09wZXJhdGlvbktleSwgXCIuIERlZmF1bHRpbmcgdG8gYW4gaW5pdGlhbCBhc3luY09wZXJhdGlvblwiKSk7XG4gICAgfVxuXG4gICAgYXN5bmNPcGVyYXRpb24gPSBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3Iub3BlcmF0aW9uVHlwZSA9PT0gX2NvbnN0YW50cy5BU1lOQ19PUEVSQVRJT05fVFlQRVMuUkVBRCA/ICgwLCBfYXN5bmNPcGVyYXRpb25VdGlscy5pbml0aWFsUmVhZEFzeW5jT3BlcmF0aW9uRm9yQWN0aW9uKShhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IuZGVzY3JpcHRvcklkLCBmaWVsZHNUb0FkZFRvQWN0aW9uLCBwYXJlbnRBc3luY09wZXJhdGlvbikgOiAoMCwgX2FzeW5jT3BlcmF0aW9uVXRpbHMuaW5pdGlhbFdyaXRlQXN5bmNPcGVyYXRpb25Gb3JBY3Rpb24pKGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvci5kZXNjcmlwdG9ySWQsIGZpZWxkc1RvQWRkVG9BY3Rpb24sIHBhcmVudEFzeW5jT3BlcmF0aW9uKTtcbiAgfSAvLyBXZSB3YW50IHRvIGRldGVybWluZSB3aGV0aGVyIG9yIG5vdCB0byB1c2UgdGhhdCBwYXJlbnRBc3luY09wZXJhdGlvbiBtZXRhRGF0YSBiYXNlZCBvbiB0aGVcbiAgLy8gbmV3bmVzcyBvZiBpdCdzIGRhdGEgaW4gY29tcGFyaXNvbiB0byB0aGUgYXN5bmNPcGVyYXRpb25cblxuXG4gIGlmIChwYXJlbnRBc3luY09wZXJhdGlvbiAmJiBhc3luY09wZXJhdGlvbikge1xuICAgIHJldHVybiBwYXJlbnRBc3luY09wZXJhdGlvbi5sYXN0RGF0YVN0YXR1c1RpbWUudmFsdWVPZigpID4gYXN5bmNPcGVyYXRpb24ubGFzdERhdGFTdGF0dXNUaW1lLnZhbHVlT2YoKSA/IF9vYmplY3RTcHJlYWQoe30sIGFzeW5jT3BlcmF0aW9uLCAoMCwgX2xvZGFzaC5waWNrKShwYXJlbnRBc3luY09wZXJhdGlvbiwgX2NvbnN0YW50cy5yZWFkQXN5bmNPcGVyYXRpb25GaWVsZHNUb1B1bGxGcm9tUGFyZW50KSkgOiBhc3luY09wZXJhdGlvbjtcbiAgfVxuXG4gIHJldHVybiBhc3luY09wZXJhdGlvbjtcbn07XG5cbnZhciB1cGRhdGVBc3luY09wZXJhdGlvbiA9IGZ1bmN0aW9uIHVwZGF0ZUFzeW5jT3BlcmF0aW9uKHN0YXRlLCBhc3luY09wZXJhdGlvbktleSwgYXN5bmNPcGVyYXRpb24sIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcikge1xuICB2YXIgY29uZmlnID0gX2NvbmZpZy5kZWZhdWx0LmdldENvbmZpZygpO1xuXG4gIGlmIChhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IuZGVidWcpIHtcbiAgICBjb25maWcubG9nZ2VyLnZlcmJvc2VMb2dnaW5nQ2FsbGJhY2soXCJJbnNpZGUgdXBkYXRlQXN5bmNPcGVyYXRpb24gZm9yIFwiLmNvbmNhdChhc3luY09wZXJhdGlvbktleSkpO1xuICAgIGNvbmZpZy5sb2dnZXIuaW5mb0xvZ2dpbmdDYWxsYmFjaygndXBkYXRlQXN5bmNPcGVyYXRpb24gW0RhdGEgU25hcHNob3RdOicsIHtcbiAgICAgIHN0YXRlOiBzdGF0ZSxcbiAgICAgIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcjogYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yLFxuICAgICAgYXN5bmNPcGVyYXRpb246IGFzeW5jT3BlcmF0aW9uLFxuICAgICAgYXN5bmNPcGVyYXRpb25LZXk6IGFzeW5jT3BlcmF0aW9uS2V5XG4gICAgfSk7XG4gIH1cblxuICBfcHJvcFR5cGVzLmRlZmF1bHQuY2hlY2tQcm9wVHlwZXMoX3R5cGVzLmFzeW5jT3BlcmF0aW9uUHJvcFR5cGUsIGFzeW5jT3BlcmF0aW9uLCAncHJvcCcsICdhc3luY09wZXJhdGlvbicpO1xuXG4gIHJldHVybiBfb2JqZWN0U3ByZWFkKHt9LCBzdGF0ZSwgX2RlZmluZVByb3BlcnR5KHt9LCBhc3luY09wZXJhdGlvbktleSwgYXN5bmNPcGVyYXRpb24pKTtcbn07XG5cbnZhciBidWxrVXBkYXRlQXN5bmNPcGVyYXRpb25zID0gZnVuY3Rpb24gYnVsa1VwZGF0ZUFzeW5jT3BlcmF0aW9ucyhzdGF0ZSwgYXN5bmNPcGVyYXRpb25zTGlzdCkge1xuICByZXR1cm4gKDAsIF9sb2Rhc2gucmVkdWNlKShhc3luY09wZXJhdGlvbnNMaXN0LCBmdW5jdGlvbiAoYWNjdW11bGF0b3IsIF9yZWYpIHtcbiAgICB2YXIgYXN5bmNPcGVyYXRpb25LZXkgPSBfcmVmLmFzeW5jT3BlcmF0aW9uS2V5LFxuICAgICAgICBhc3luY09wZXJhdGlvbiA9IF9yZWYuYXN5bmNPcGVyYXRpb24sXG4gICAgICAgIGFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvciA9IF9yZWYuYXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yO1xuICAgIHJldHVybiB1cGRhdGVBc3luY09wZXJhdGlvbihhY2N1bXVsYXRvciwgYXN5bmNPcGVyYXRpb25LZXksIGFzeW5jT3BlcmF0aW9uLCBhc3luY09wZXJhdGlvbkRlc2NyaXB0b3IpO1xuICB9LCBzdGF0ZSk7XG59O1xuXG52YXIgX2RlZmF1bHQgPSB7XG4gIHVwZGF0ZUFzeW5jT3BlcmF0aW9uRGVzY3JpcHRvcjogdXBkYXRlQXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yLFxuICB1cGRhdGVBc3luY09wZXJhdGlvbjogdXBkYXRlQXN5bmNPcGVyYXRpb24sXG4gIGJ1bGtVcGRhdGVBc3luY09wZXJhdGlvbnM6IGJ1bGtVcGRhdGVBc3luY09wZXJhdGlvbnMsXG4gIGdldEFzeW5jT3BlcmF0aW9uOiBnZXRBc3luY09wZXJhdGlvbixcbiAgZ2V0QXN5bmNPcGVyYXRpb25EZXNjcmlwdG9yOiBnZXRBc3luY09wZXJhdGlvbkRlc2NyaXB0b3Jcbn07XG5leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsiXX0=