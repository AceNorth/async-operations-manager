{"version":3,"sources":["../src/asyncOperationManagerUtils.js"],"names":["getAsyncOperationsManagerState","asyncOperationManagerState","getState","clearAsyncOperationsManagerState","clearState","setAsyncOperationsManagerState","setState","registerAsyncOperationDescriptors","asyncOperationDescriptors","newState","state","config","asyncOperationManagerConfig","getConfig","otherDescriptors","logger","exceptionsCallback","Error","acc","asyncOperationDescriptor","asyncOperationStateUtils","updateAsyncOperationDescriptor","getAsyncOperation","descriptorId","params","otherFields","descriptors","asyncOperationParams","asyncOperationKey","shouldRunOperation","asyncOperation","operationType","ASYNC_OPERATION_TYPES","READ","fetchStatus","FETCH_STATUS","NULL","Date","now","lastFetchStatusTime","minCacheTime","readStepLookup","ASYNC_OPERATION_STEPS","BEGIN_ASYNC_OPERATION","RESOLVE_ASYNC_OPERATION","REJECT_ASYNC_OPERATION","writeStepLookup","transformTypeLookup","asyncOperationStep","WRITE","getStateForOperationAfterStep","asyncOperationToTranform","newAsyncOperation","updateAsyncOperation","operations"],"mappings":"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","sourcesContent":["// TODO: JSDocify every function\n\n// \n// This file contains the 'switchboard' logic to coordinate the various\n// lower-level functions that update state. These functions are exposed\n// to the consumer of the library.\n//\n\nimport {\n  isArray,\n  isEmpty,\n  reduce,\n} from 'lodash';\n\nimport asyncOperationStateUtils from './asyncOperationStateUtils';\nimport asyncOperationManagerConfig from './config';\nimport { asyncOperationManagerState } from './asyncOperationManagerState';\n\nimport {\n  beginReadAsyncOperation,\n  beginWriteAsyncOperation,\n  resolveReadAsyncOperation,\n  resolveWriteAsyncOperation,\n  rejectReadAsyncOperation,\n  rejectWriteAsyncOperation,\n} from './asyncOperationUtils';\n\nimport {\n  getAsyncOperationInfo,\n} from './helpers';\n\nimport {\n  ASYNC_OPERATION_TYPES,\n  ASYNC_OPERATION_STEPS,\n  FETCH_STATUS,\n} from './constants';\n\nconst getAsyncOperationsManagerState = asyncOperationManagerState.getState;\nconst clearAsyncOperationsManagerState = asyncOperationManagerState.clearState;\nconst setAsyncOperationsManagerState = asyncOperationManagerState.setState;\n\nconst registerAsyncOperationDescriptors = (asyncOperationDescriptors, ...otherDescriptors) => {\n  let newState;\n  const state = getAsyncOperationsManagerState();\n  const config = asyncOperationManagerConfig.getConfig();\n\n  if (!isEmpty(otherDescriptors)) {\n    config.logger.exceptionsCallback(`\n      You provided more than one argument to registerAsyncOperationDescriptors.\n      You likely forgot to put multiple descriptors within an array`, new Error());\n  }\n  // handle array or single object arguments\n  if (isArray(asyncOperationDescriptors)) {\n    newState = reduce(asyncOperationDescriptors, (acc, asyncOperationDescriptor) => {\n      return asyncOperationStateUtils.updateAsyncOperationDescriptor(acc, asyncOperationDescriptor);\n    }, state);\n  } else {\n    newState = asyncOperationStateUtils.updateAsyncOperationDescriptor(state, asyncOperationDescriptors);\n  }\n\n  return asyncOperationManagerState.setState(newState);\n};\n\nconst getAsyncOperation = (state, descriptorId, params, otherFields) => {\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n    asyncOperationKey,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  // in case operation/descriptor state is initialized in userland we pass that through\n  // to the library state.\n  const newState = asyncOperationManagerState.setState(state);\n\n  return asyncOperationStateUtils.getAsyncOperation(newState, asyncOperationKey, asyncOperationDescriptor, asyncOperationParams, otherFields);\n};\n\nconst shouldRunOperation = (descriptorId, params) => {\n  const state = asyncOperationManagerState.getState();\n\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  const asyncOperation = getAsyncOperation(state, descriptorId, asyncOperationParams);\n\n  if (asyncOperationDescriptor.operationType === ASYNC_OPERATION_TYPES.READ && asyncOperation.fetchStatus !== FETCH_STATUS.NULL) {\n    return (Date.now() - asyncOperation.lastFetchStatusTime) >= asyncOperationDescriptor.minCacheTime;\n  }\n\n  return true;\n};\n\n// switchboard for resolving the Read operation steps\nconst readStepLookup = {\n  [ASYNC_OPERATION_STEPS.BEGIN_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => beginReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.RESOLVE_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => resolveReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.REJECT_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => rejectReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n};\n\n// switchboard for resolving Write operation steps\nconst writeStepLookup = {\n  [ASYNC_OPERATION_STEPS.BEGIN_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => beginWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.RESOLVE_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => resolveWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.REJECT_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => rejectWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n};\n\n// first switchboard to transform an async operation\nconst transformTypeLookup = {\n  [ASYNC_OPERATION_TYPES.READ]:\n    (asyncOperation, asyncOperationStep, asyncOperationParams, otherFields) => readStepLookup[asyncOperationStep](asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_TYPES.WRITE]:\n    (asyncOperation, asyncOperationStep, asyncOperationParams, otherFields) => writeStepLookup[asyncOperationStep](asyncOperation, asyncOperationParams, otherFields),\n};\n\n// this function is called in the reducer (in redux integration)\nconst getStateForOperationAfterStep = (state, asyncOperationStep, descriptorId, params) => {\n  let newState = asyncOperationManagerState.setState(state);\n\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n    asyncOperationKey,\n    otherFields,\n  } = getAsyncOperationInfo(newState.descriptors, descriptorId, params);\n\n  // in case operation/descriptor state is initialized in userland we pass that through\n  // to the library state.\n\n  const asyncOperationToTranform = getAsyncOperation(newState, descriptorId, asyncOperationParams, otherFields);\n  const newAsyncOperation = transformTypeLookup[asyncOperationDescriptor.operationType](asyncOperationToTranform, asyncOperationStep, asyncOperationParams, otherFields);\n\n  newState = asyncOperationStateUtils.updateAsyncOperation(newState, asyncOperationKey, newAsyncOperation, asyncOperationDescriptor);\n  return asyncOperationManagerState.setState(newState).operations;\n};\n\nexport {\n  getAsyncOperationsManagerState,\n  clearAsyncOperationsManagerState,\n  setAsyncOperationsManagerState,\n\n  getAsyncOperation,\n  registerAsyncOperationDescriptors,\n  getStateForOperationAfterStep,\n\n  shouldRunOperation,\n};\n"],"file":"asyncOperationManagerUtils.js"}